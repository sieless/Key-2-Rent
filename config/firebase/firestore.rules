rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ✅ USERS COLLECTION
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ✅ LISTINGS COLLECTION
    match /listings/{listingId} {
      // Anyone can view listings
      allow read: if true;

      // Authenticated landlords (or users) can post
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId &&
        (
          request.resource.data.status == 'Vacant' &&
          request.resource.data.paymentStatus == 'pending'
        ) ||
        (
          request.resource.data.status in ['Occupied', 'Available Soon'] &&
          request.resource.data.paymentStatus == 'paid'
        );

      // Allow landlords to manage their listings
      allow update, delete: if request.auth != null &&
        (request.auth.uid == resource.data.userId);
    }

    // ✅ ADMIN NOTIFICATIONS
    match /admin_notifications/{docId} {
      allow read, create: if request.auth != null;
    }

    // ✅ GENERAL NOTIFICATIONS
    match /notifications/{docId} {
      allow read, create, update: if request.auth != null;
    }

    // ✅ PLATFORM SETTINGS
    match /platform_settings/{settingId} {
      allow read: if true; // Public read for platform settings
      allow write: if request.auth != null; // Admin can write
    }

    // ✅ FEATURED PROPERTIES
    match /featured_properties/{propertyId} {
      allow read: if true; // Public read
      allow write: if request.auth != null; // Authenticated write
    }

    // ✅ CONVERSATIONS
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null &&
        request.auth.uid in resource.data.participants;
      allow create: if request.auth != null;
    }

    // ✅ MESSAGES
    match /messages/{messageId} {
      allow read, write: if request.auth != null;
    }

    // ✅ AGREEMENTS
    match /agreements/{agreementId} {
      allow read, write: if request.auth != null;
    }

    // ✅ TRANSACTIONS
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null;
    }

    // ✅ RATE LIMITING
    match /rate_limits/{limitId} {
      allow read, write: if request.auth != null;
    }

    // ✅ ERROR LOGS
    match /error_logs/{errorId} {
      allow read, write: if request.auth != null;
    }

    // ✅ FALLBACK (allow authenticated reads for any other collections)
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}