rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ✅ USERS COLLECTION
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ✅ LISTINGS COLLECTION
    match /listings/{listingId} {
      // Anyone can view listings
      allow read: if true;

      // Authenticated landlords (or users) can post
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId &&
        (
          request.resource.data.status == 'Vacant' &&
          request.resource.data.paymentStatus == 'pending'
        ) ||
        (
          request.resource.data.status in ['Occupied', 'Available Soon'] &&
          request.resource.data.paymentStatus == 'paid'
        );

      // Allow landlords to manage their listings
      allow update, delete: if request.auth != null &&
        (request.auth.uid == resource.data.userId);
    }

    // ✅ ADMIN NOTIFICATIONS
    match /admin_notifications/{docId} {
      allow read, create: if request.auth != null;
    }

    // ✅ GENERAL NOTIFICATIONS
    match /notifications/{docId} {
      allow read, create, update: if request.auth != null;
    }

    // ✅ FALLBACK (allow authenticated reads)
    match /{document=**} {
      allow read: if request.auth != null;
    }
  }
}