#!/usr/bin/env sh

echo "üîí Running security checks..."

# Check for potential secrets in staged files (excluding legitimate Cloudinary URLs)
if git diff --cached --diff-filter=ACM | grep -E 'AIzaSy|AKIA|sk_live|pk_live|api[_-]?key.*=.*["\x27][A-Za-z0-9]{20,}|secret[_-]?key.*=.*["\x27][A-Za-z0-9]{20,}|_CnUV1xPCLUBUStRjBE7ej4g7c4|838682876814497|183517980169' | grep -v 'res\.cloudinary\.com'; then
  echo ""
  echo "‚ùå ERROR: Potential API key or secret detected in staged files!"
  echo ""
  echo "Found pattern that looks like a secret. Please:"
  echo "  1. Remove the secret from your code"
  echo "  2. Use environment variables instead"
  echo "  3. Add the value to .env.local (which is gitignored)"
  echo ""
  echo "If this is a false positive, you can bypass with: git commit --no-verify"
  echo "(But please be sure it's actually safe first!)"
  echo ""
  exit 1
fi

# Check for .env files being committed
if git diff --cached --name-only --diff-filter=ACM | grep -E '^\.env$|^\.env\.local$|^\.env\.production$|\.env\.development$'; then
  echo ""
  echo "‚ùå ERROR: .env file detected in staged files!"
  echo ""
  echo "NEVER commit .env files to git. They contain secrets."
  echo ""
  echo "To fix:"
  echo "  git restore --staged .env .env.local"
  echo ""
  exit 1
fi

# Check for VERCEL_SETUP.md or similar sensitive docs
if git diff --cached --name-only --diff-filter=ACM | grep -iE 'vercel.*setup|credentials|secrets'; then
  echo ""
  echo "‚ö†Ô∏è  WARNING: Potentially sensitive documentation file detected!"
  echo ""
  echo "Files with names like 'credentials', 'secrets', or 'setup' may contain"
  echo "sensitive information. Please verify before committing."
  echo ""
  read -p "Are you sure this file is safe to commit? (y/N): " confirm
  if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "Commit cancelled."
    exit 1
  fi
fi

echo "‚úÖ Security checks passed!"
